"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("@descope/core-js-sdk"),n=require("jwt-decode"),i=require("js-cookie"),o=require("@fingerprintjs/fingerprintjs-pro");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=a(t),s=a(i);const l=(e,t)=>{var n;return["beforeRequest","afterRequest"].reduce(((n,i)=>{var o;return n[i]=[].concat((null===(o=e.hooks)||void 0===o?void 0:o[i])||[]).concat((null==t?void 0:t[i])||[]),n}),null!==(n=e.hooks)&&void 0!==n?n:e.hooks={}),e},c=async e=>{if(!(null==e?void 0:e.ok))return{};const t=await(null==e?void 0:e.clone().json());return(null==t?void 0:t.authInfo)||t||{}},u=async e=>{const t=await c(e);return(null==t?void 0:t.user)||((null==t?void 0:t.hasOwnProperty("userId"))?t:void 0)},d="undefined"!=typeof localStorage,g=(e,t)=>d&&(null===localStorage||void 0===localStorage?void 0:localStorage.setItem(e,t)),p=e=>d&&(null===localStorage||void 0===localStorage?void 0:localStorage.getItem(e)),f=e=>d&&(null===localStorage||void 0===localStorage?void 0:localStorage.removeItem(e)),w=(...e)=>{console.debug(...e)},v="undefined"!=typeof window,h=Math.pow(2,31)-1,b="DS",m="DSR";function y(e,t,{cookiePath:n,cookieDomain:i,cookieExpiration:o,cookieSameSite:a="Strict"}){if(t){const r=new Date(1e3*o),l=function(e){const t=window.location.hostname.split("."),n=e.split(".");return t.slice(-n.length).join(".")===e}(i);s.default.set(e,t,{path:n,domain:l?i:void 0,expires:r,sameSite:a,secure:!0})}}function S(e=""){return p(`${e}${m}`)||""}function I(e=""){return s.default.get(b)||p(`${e}${b}`)||""}function O(e=""){f(`${e}${m}`),f(`${e}${b}`),s.default.remove(b)}const k=v&&(null===localStorage||void 0===localStorage?void 0:localStorage.getItem("fingerprint.endpoint.url"))||"https://api.descope.com",j="vsid",_="vrid",U="fp",x=(e=!1)=>{const t=localStorage.getItem(U);if(!t)return null;const n=JSON.parse(t);return(new Date).getTime()>n.expiry&&!e?null:n.value},D=async(e,t=k)=>{try{if(x())return;const n=(Date.now().toString(36)+Math.random().toString(36).substring(2)+Math.random().toString(36).substring(2)).substring(0,27),i=new URL(t);i.pathname="/fXj8gt3x8VulJBna/x96Emn69oZwcd7I6";const a=new URL(t);a.pathname="/fXj8gt3x8VulJBna/w78aRZnnDZ3Aqw0I";const r=a.toString()+"?apiKey=<apiKey>&version=<version>&loaderVersion=<loaderVersion>",s=o.load({apiKey:e,endpoint:[i.toString(),o.defaultEndpoint],scriptUrlPattern:[r,o.defaultScriptUrlPattern]}),l=await s,{requestId:c}=await l.get({linkedId:n}),u=((e,t)=>({[j]:e,[_]:t}))(n,c);(e=>{const t={value:e,expiry:(new Date).getTime()+864e5};localStorage.setItem(U,JSON.stringify(t))})(u)}catch(e){console.warn("Could not load fingerprint",e)}},A=e=>{const t=x(!0);return t&&e.body&&(e.body.fpData=t),e},R="dls_last_user_login_id",T="dls_last_user_display_name",C=()=>p(R),L=()=>p(T),K=e=>async(...t)=>{var n;t[1]=t[1]||{};const[,i={}]=t,o=C(),a=L();o&&(null!==(n=i.lastAuth)&&void 0!==n||(i.lastAuth={}),i.lastAuth.loginId=o,i.lastAuth.name=a);return await e(...t)},E=e=>t=>async(...n)=>{const i=await t(...n);return e||(f(R),f(T)),i};function J(){const e=[];return{pub:t=>{e.forEach((e=>e(t)))},sub:t=>{const n=e.push(t)-1;return()=>e.splice(n,1)}}}const N=e=>t=>async(...n)=>{const i=await t(...n);return O(e),i};async function $(e){const t=function(e){var t;const n=JSON.parse(e);return n.publicKey.challenge=F(n.publicKey.challenge),n.publicKey.user.id=F(n.publicKey.user.id),null===(t=n.publicKey.excludeCredentials)||void 0===t||t.forEach((e=>{e.id=F(e.id)})),n}(e),n=await navigator.credentials.create(t);return i=n,JSON.stringify({id:i.id,rawId:W(i.rawId),type:i.type,response:{attestationObject:W(i.response.attestationObject),clientDataJSON:W(i.response.clientDataJSON)}});var i}async function q(e){const t=H(e);return M(await navigator.credentials.get(t))}async function P(e,t){const n=H(e);n.signal=t.signal,n.mediation="conditional";return M(await navigator.credentials.get(n))}async function V(e=!1){if(!v)return Promise.resolve(!1);const t=!!(window.PublicKeyCredential&&navigator.credentials&&navigator.credentials.create&&navigator.credentials.get);return t&&e&&PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable?PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable():t}function H(e){var t;const n=JSON.parse(e);return n.publicKey.challenge=F(n.publicKey.challenge),null===(t=n.publicKey.allowCredentials)||void 0===t||t.forEach((e=>{e.id=F(e.id)})),n}function M(e){return JSON.stringify({id:e.id,rawId:W(e.rawId),type:e.type,response:{authenticatorData:W(e.response.authenticatorData),clientDataJSON:W(e.response.clientDataJSON),signature:W(e.response.signature),userHandle:e.response.userHandle?W(e.response.userHandle):void 0}})}function F(e){const t=e.replace(/_/g,"/").replace(/-/g,"+");return Uint8Array.from(atob(t),(e=>e.charCodeAt(0))).buffer}function W(e){return btoa(String.fromCharCode.apply(null,new Uint8Array(e))).replace(/\//g,"_").replace(/\+/g,"-").replace(/=/g,"")}var G,B=(G=e=>({async signUp(t,n,i){const o=await e.webauthn.signUp.start(t,window.location.origin,n,i);if(!o.ok)return o;const a=await $(o.data.options);return await e.webauthn.signUp.finish(o.data.transactionId,a)},async signIn(t,n){const i=await e.webauthn.signIn.start(t,window.location.origin,void 0,void 0,n);if(!i.ok)return i;const o=await q(i.data.options);return await e.webauthn.signIn.finish(i.data.transactionId,o)},async signUpOrIn(t,n){var i;const o=await e.webauthn.signUpOrIn.start(t,window.location.origin,n);if(!o.ok)return o;if(null===(i=o.data)||void 0===i?void 0:i.create){const t=await $(o.data.options);return await e.webauthn.signUp.finish(o.data.transactionId,t)}{const t=await q(o.data.options);return await e.webauthn.signIn.finish(o.data.transactionId,t)}},async update(t,n,i){const o=await e.webauthn.update.start(t,window.location.origin,n,i);if(!o.ok)return o;const a=await $(o.data.options);return await e.webauthn.update.finish(o.data.transactionId,a)},helpers:{create:$,get:q,isSupported:V,conditional:P}}),(...e)=>{const t=G(...e);return Object.assign(t.signUp,e[0].webauthn.signUp),Object.assign(t.signIn,e[0].webauthn.signIn),Object.assign(t.signUpOrIn,e[0].webauthn.signUpOrIn),Object.assign(t.update,e[0].webauthn.update),t});const Z={config:"/fedcm/config"},X=(e,t)=>({async oneTap(t,n,i,o,a){const r=null!=t?t:"google",s=await e.oauth.startNative(r,i,!0);if(!s.ok)return s;const{clientId:l,stateId:c,nonce:u}=s.data,d=await async function(){return new Promise(((e,t)=>{if(window.google)return void e(window.google.accounts.id);let n=document.getElementById("google-gsi-client-script");n||(n=document.createElement("script"),document.head.appendChild(n),n.async=!0,n.defer=!0,n.id="google-gsi-client-script",n.src="https://accounts.google.com/gsi/client"),n.onload=function(){window.google?e(window.google.accounts.id):t("Failed to load Google GSI client script - not loaded properly")},n.onerror=function(){t("Failed to load Google GSI client script - failed to load")}}))}();return new Promise((t=>{var i,s;d.initialize(Object.assign(Object.assign({},n),{itp_support:null===(i=null==n?void 0:n.itp_support)||void 0===i||i,use_fedcm_for_prompt:null===(s=null==n?void 0:n.use_fedcm_for_prompt)||void 0===s||s,client_id:l,callback:n=>{t(e.oauth.finishNative(r,c,"","",n.credential))},nonce:u})),d.prompt((e=>{var t,n;if(a&&(null==e?void 0:e.isDismissedMoment())){const n=null===(t=e.getDismissedReason)||void 0===t?void 0:t.call(e);null==a||a(n)}else if(o&&(null==e?void 0:e.isSkippedMoment())){const t=null===(n=e.getSkippedReason)||void 0===n?void 0:n.call(e);null==o||o(t)}else;}))}))},async launch(n){var i;const o={identity:{context:n||"signin",providers:[{configURL:e.httpClient.buildUrl(t+Z.config),clientId:t}]}},a=await(null===(i=navigator.credentials)||void 0===i?void 0:i.get(o));return e.refresh(a.token)},isSupported:()=>v&&"IdentityCredential"in window,async isLoggedIn(n){var i;const o=e.httpClient.buildUrl(t+Z.config);try{const e={identity:{context:n||"signin",providers:[{configURL:o,clientId:t}]}},a=await(null===(i=navigator.credentials)||void 0===i?void 0:i.get(e));return!!a&&!!a.token}catch(e){return!1}}});var Y=e=>Object.assign(Object.assign({},e.flow),{start:async(...t)=>{const n=await V(),i=Object.assign(Object.assign({location:window.location.href},t[1]),{deviceInfo:{webAuthnSupport:n},startOptionsVersion:1});return t[1]=i,e.flow.start(...t)}});const z=function(...e){return t=>e.reduce(((e,t)=>t(e)),t)}((t=>n=>{var{fpKey:i,fpLoad:o}=n,a=e.__rest(n,["fpKey","fpLoad"]);return v?(i&&o&&D(i).catch((()=>null)),t(l(a,{beforeRequest:A}))):t(a)}),(i=>o=>{var{autoRefresh:a}=o,r=e.__rest(o,["autoRefresh"]);if(!a)return i(r);const{clearAllTimers:s,setTimer:u}=(()=>{const e=[];return{clearAllTimers:()=>{for(;e.length;)clearTimeout(e.pop())},setTimer:(t,n)=>{e.push(setTimeout(t,n))}}})();let d,g;v&&document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&new Date>d&&(w("Expiration time passed, refreshing session"),p.refresh(S()||g))}));const p=i(l(r,{afterRequest:async(e,t)=>{const{refreshJwt:i,sessionJwt:o,sessionExpiration:a}=await c(t);if(401===(null==t?void 0:t.status))w("Received 401, canceling all timers"),s();else if(o||a){if(d=((e,t)=>{if(t)return new Date(1e3*t);w("Could not extract expiration time from session token, trying to decode the token");try{const t=n.jwtDecode(e);if(t.exp)return new Date(1e3*t.exp)}catch(e){return null}})(o,a),!d)return void w("Could not extract expiration time from session token");g=i;let e=((r=d)?r.getTime()-(new Date).getTime():0)-2e4;e>h&&(w(`Timeout is too large (${e}ms), setting it to ${h}ms`),e=h),s();const t=new Date(Date.now()+e).toLocaleTimeString("en-US",{hour12:!1});w(`Setting refresh timer for ${t}. (${e}ms)`),u((()=>{w("Refreshing session due to timer"),p.refresh(S()||i)}),e)}var r}}));return t.wrapWith(p,["logout","logoutAll"],(e=>async(...t)=>{const n=await e(...t);return w("Clearing all timers"),s(),n}))}),(e=>t=>e(Object.assign(Object.assign({},t),{baseHeaders:Object.assign({"x-descope-sdk-name":"web-js","x-descope-sdk-version":"1.26.2"},t.baseHeaders)}))),(e=>n=>{const i=J(),o=J(),a=J(),r=e(l(n,{afterRequest:async(e,t)=>{if(401===(null==t?void 0:t.status))o.pub(null),a.pub(null),i.pub(null);else{const e=await u(t);e&&a.pub(e);const{sessionJwt:n,sessionExpiration:r}=await c(t);n&&o.pub(n),(r||n)&&i.pub(r||42)}}})),s=t.wrapWith(r,["logout","logoutAll"],(e=>async(...t)=>{const n=await e(...t);return o.pub(null),a.pub(null),i.pub(null),n}));return Object.assign(s,{onSessionTokenChange:o.sub,onUserChange:a.sub,onIsAuthenticatedChange:e=>i.sub((t=>{e(!!t)}))})}),(n=>i=>{var{storeLastAuthenticatedUser:o=!0,keepLastAuthenticatedUserAfterLogout:a=!1}=i,r=e.__rest(i,["storeLastAuthenticatedUser","keepLastAuthenticatedUserAfterLogout"]);if(!o)return Object.assign(n(r),{getLastUserLoginId:C,getLastUserDisplayName:L});const s=n(l(r,{afterRequest:async(e,t)=>{var n;const i=await u(t),o=null===(n=null==i?void 0:i.loginIds)||void 0===n?void 0:n[0],a=null==i?void 0:i.name;o&&((e=>{g(R,e)})(o),(e=>{g(T,e)})(a))}}));let c=t.wrapWith(s,["flow.start"],K);return c=t.wrapWith(c,["logout","logoutAll"],E(a)),Object.assign(c,{getLastUserLoginId:C,getLastUserDisplayName:L})}),(n=>i=>{var{persistTokens:o,sessionTokenViaCookie:a,storagePrefix:r}=i,s=e.__rest(i,["persistTokens","sessionTokenViaCookie","storagePrefix"]);if(!o||!v)return n(s);const u=n(l(s,{beforeRequest:(d=r,e=>Object.assign(e,{token:e.token||S(d)})),afterRequest:async(t,n)=>{const i=/^\/v\d+\/mgmt\//.test(t.path);401===(null==n?void 0:n.status)?i||O(r):((t={},n,i)=>{var{refreshJwt:o,sessionJwt:a}=t,r=e.__rest(t,["refreshJwt","sessionJwt"]);void 0===n&&(n=!1),void 0===i&&(i=""),o&&g(`${i}${m}`,o),a&&(n?y(b,a,Object.assign(Object.assign({},r),{cookieSameSite:!0===n?"Strict":n.sameSite})):g(`${i}${b}`,a))})(await c(n),a,r)}}));var d;const p=t.wrapWith(u,["logout","logoutAll"],N(r));return Object.assign(p,{getRefreshToken:()=>S(r),getSessionToken:()=>I(r)})}))(((...e)=>{const t=r.default(...e);return Object.assign(Object.assign({},t),{refresh:e=>{const n=I();return t.refresh(e,{dcs:n?"t":"f"})},flow:Y(t),webauthn:B(t),fedcm:X(t,e[0].projectId)})}));exports.REFRESH_TOKEN_KEY=m,exports.SESSION_TOKEN_KEY=b,exports.clearFingerprintData=()=>{localStorage.removeItem(U)},exports.default=z,exports.ensureFingerprintIds=D;
//# sourceMappingURL=index.cjs.js.map
