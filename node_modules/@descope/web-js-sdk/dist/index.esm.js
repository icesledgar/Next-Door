import{__rest as t}from"tslib";import e,{wrapWith as n}from"@descope/core-js-sdk";import{jwtDecode as o}from"jwt-decode";import i from"js-cookie";import{load as a,defaultEndpoint as s,defaultScriptUrlPattern as r}from"@fingerprintjs/fingerprintjs-pro";const l=(t,e)=>{var n;return["beforeRequest","afterRequest"].reduce(((n,o)=>{var i;return n[o]=[].concat((null===(i=t.hooks)||void 0===i?void 0:i[o])||[]).concat((null==e?void 0:e[o])||[]),n}),null!==(n=t.hooks)&&void 0!==n?n:t.hooks={}),t},c=async t=>{if(!(null==t?void 0:t.ok))return{};const e=await(null==t?void 0:t.clone().json());return(null==e?void 0:e.authInfo)||e||{}},u=async t=>{const e=await c(t);return(null==e?void 0:e.user)||((null==e?void 0:e.hasOwnProperty("userId"))?e:void 0)},d="undefined"!=typeof localStorage,g=(t,e)=>d&&(null===localStorage||void 0===localStorage?void 0:localStorage.setItem(t,e)),p=t=>d&&(null===localStorage||void 0===localStorage?void 0:localStorage.getItem(t)),f=t=>d&&(null===localStorage||void 0===localStorage?void 0:localStorage.removeItem(t)),w=(...t)=>{console.debug(...t)},v="undefined"!=typeof window,h=Math.pow(2,31)-1,m="DS",b="DSR";function y(t,e,{cookiePath:n,cookieDomain:o,cookieExpiration:a,cookieSameSite:s="Strict"}){if(e){const r=new Date(1e3*a),l=function(t){const e=window.location.hostname.split("."),n=t.split(".");return e.slice(-n.length).join(".")===t}(o);i.set(t,e,{path:n,domain:l?o:void 0,expires:r,sameSite:s,secure:!0})}}function S(t=""){return p(`${t}${b}`)||""}function I(t=""){return i.get(m)||p(`${t}${m}`)||""}function k(t=""){f(`${t}${b}`),f(`${t}${m}`),i.remove(m)}const O=v&&(null===localStorage||void 0===localStorage?void 0:localStorage.getItem("fingerprint.endpoint.url"))||"https://api.descope.com",j="vsid",U="vrid",A="fp",D=(t=!1)=>{const e=localStorage.getItem(A);if(!e)return null;const n=JSON.parse(e);return(new Date).getTime()>n.expiry&&!t?null:n.value},x=async(t,e=O)=>{try{if(D())return;const n=(Date.now().toString(36)+Math.random().toString(36).substring(2)+Math.random().toString(36).substring(2)).substring(0,27),o=new URL(e);o.pathname="/fXj8gt3x8VulJBna/x96Emn69oZwcd7I6";const i=new URL(e);i.pathname="/fXj8gt3x8VulJBna/w78aRZnnDZ3Aqw0I";const l=i.toString()+"?apiKey=<apiKey>&version=<version>&loaderVersion=<loaderVersion>",c=a({apiKey:t,endpoint:[o.toString(),s],scriptUrlPattern:[l,r]}),u=await c,{requestId:d}=await u.get({linkedId:n}),g=((t,e)=>({[j]:t,[U]:e}))(n,d);(t=>{const e={value:t,expiry:(new Date).getTime()+864e5};localStorage.setItem(A,JSON.stringify(e))})(g)}catch(t){console.warn("Could not load fingerprint",t)}},C=()=>{localStorage.removeItem(A)},L=t=>{const e=D(!0);return e&&t.body&&(t.body.fpData=e),t},R="dls_last_user_login_id",T="dls_last_user_display_name",J=()=>p(R),_=()=>p(T),K=t=>async(...e)=>{var n;e[1]=e[1]||{};const[,o={}]=e,i=J(),a=_();i&&(null!==(n=o.lastAuth)&&void 0!==n||(o.lastAuth={}),o.lastAuth.loginId=i,o.lastAuth.name=a);return await t(...e)},$=t=>e=>async(...n)=>{const o=await e(...n);return t||(f(R),f(T)),o};function N(){const t=[];return{pub:e=>{t.forEach((t=>t(e)))},sub:e=>{const n=t.push(e)-1;return()=>t.splice(n,1)}}}const P=t=>e=>async(...n)=>{const o=await e(...n);return k(t),o};async function E(t){const e=function(t){var e;const n=JSON.parse(t);return n.publicKey.challenge=B(n.publicKey.challenge),n.publicKey.user.id=B(n.publicKey.user.id),null===(e=n.publicKey.excludeCredentials)||void 0===e||e.forEach((t=>{t.id=B(t.id)})),n}(t),n=await navigator.credentials.create(e);return o=n,JSON.stringify({id:o.id,rawId:Z(o.rawId),type:o.type,response:{attestationObject:Z(o.response.attestationObject),clientDataJSON:Z(o.response.clientDataJSON)}});var o}async function q(t){const e=M(t);return G(await navigator.credentials.get(e))}async function V(t,e){const n=M(t);n.signal=e.signal,n.mediation="conditional";return G(await navigator.credentials.get(n))}async function H(t=!1){if(!v)return Promise.resolve(!1);const e=!!(window.PublicKeyCredential&&navigator.credentials&&navigator.credentials.create&&navigator.credentials.get);return e&&t&&PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable?PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable():e}function M(t){var e;const n=JSON.parse(t);return n.publicKey.challenge=B(n.publicKey.challenge),null===(e=n.publicKey.allowCredentials)||void 0===e||e.forEach((t=>{t.id=B(t.id)})),n}function G(t){return JSON.stringify({id:t.id,rawId:Z(t.rawId),type:t.type,response:{authenticatorData:Z(t.response.authenticatorData),clientDataJSON:Z(t.response.clientDataJSON),signature:Z(t.response.signature),userHandle:t.response.userHandle?Z(t.response.userHandle):void 0}})}function B(t){const e=t.replace(/_/g,"/").replace(/-/g,"+");return Uint8Array.from(atob(e),(t=>t.charCodeAt(0))).buffer}function Z(t){return btoa(String.fromCharCode.apply(null,new Uint8Array(t))).replace(/\//g,"_").replace(/\+/g,"-").replace(/=/g,"")}var F,X=(F=t=>({async signUp(e,n,o){const i=await t.webauthn.signUp.start(e,window.location.origin,n,o);if(!i.ok)return i;const a=await E(i.data.options);return await t.webauthn.signUp.finish(i.data.transactionId,a)},async signIn(e,n){const o=await t.webauthn.signIn.start(e,window.location.origin,void 0,void 0,n);if(!o.ok)return o;const i=await q(o.data.options);return await t.webauthn.signIn.finish(o.data.transactionId,i)},async signUpOrIn(e,n){var o;const i=await t.webauthn.signUpOrIn.start(e,window.location.origin,n);if(!i.ok)return i;if(null===(o=i.data)||void 0===o?void 0:o.create){const e=await E(i.data.options);return await t.webauthn.signUp.finish(i.data.transactionId,e)}{const e=await q(i.data.options);return await t.webauthn.signIn.finish(i.data.transactionId,e)}},async update(e,n,o){const i=await t.webauthn.update.start(e,window.location.origin,n,o);if(!i.ok)return i;const a=await E(i.data.options);return await t.webauthn.update.finish(i.data.transactionId,a)},helpers:{create:E,get:q,isSupported:H,conditional:V}}),(...t)=>{const e=F(...t);return Object.assign(e.signUp,t[0].webauthn.signUp),Object.assign(e.signIn,t[0].webauthn.signIn),Object.assign(e.signUpOrIn,t[0].webauthn.signUpOrIn),Object.assign(e.update,t[0].webauthn.update),e});const z={config:"/fedcm/config"},Q=(t,e)=>({async oneTap(e,n,o,i,a){const s=null!=e?e:"google",r=await t.oauth.startNative(s,o,!0);if(!r.ok)return r;const{clientId:l,stateId:c,nonce:u}=r.data,d=await async function(){return new Promise(((t,e)=>{if(window.google)return void t(window.google.accounts.id);let n=document.getElementById("google-gsi-client-script");n||(n=document.createElement("script"),document.head.appendChild(n),n.async=!0,n.defer=!0,n.id="google-gsi-client-script",n.src="https://accounts.google.com/gsi/client"),n.onload=function(){window.google?t(window.google.accounts.id):e("Failed to load Google GSI client script - not loaded properly")},n.onerror=function(){e("Failed to load Google GSI client script - failed to load")}}))}();return new Promise((e=>{var o,r;d.initialize(Object.assign(Object.assign({},n),{itp_support:null===(o=null==n?void 0:n.itp_support)||void 0===o||o,use_fedcm_for_prompt:null===(r=null==n?void 0:n.use_fedcm_for_prompt)||void 0===r||r,client_id:l,callback:n=>{e(t.oauth.finishNative(s,c,"","",n.credential))},nonce:u})),d.prompt((t=>{var e,n;if(a&&(null==t?void 0:t.isDismissedMoment())){const n=null===(e=t.getDismissedReason)||void 0===e?void 0:e.call(t);null==a||a(n)}else if(i&&(null==t?void 0:t.isSkippedMoment())){const e=null===(n=t.getSkippedReason)||void 0===n?void 0:n.call(t);null==i||i(e)}else;}))}))},async launch(n){var o;const i={identity:{context:n||"signin",providers:[{configURL:t.httpClient.buildUrl(e+z.config),clientId:e}]}},a=await(null===(o=navigator.credentials)||void 0===o?void 0:o.get(i));return t.refresh(a.token)},isSupported:()=>v&&"IdentityCredential"in window,async isLoggedIn(n){var o;const i=t.httpClient.buildUrl(e+z.config);try{const t={identity:{context:n||"signin",providers:[{configURL:i,clientId:e}]}},a=await(null===(o=navigator.credentials)||void 0===o?void 0:o.get(t));return!!a&&!!a.token}catch(t){return!1}}});var W=t=>Object.assign(Object.assign({},t.flow),{start:async(...e)=>{const n=await H(),o=Object.assign(Object.assign({location:window.location.href},e[1]),{deviceInfo:{webAuthnSupport:n},startOptionsVersion:1});return e[1]=o,t.flow.start(...e)}});const Y=function(...t){return e=>t.reduce(((t,e)=>e(t)),e)}((e=>n=>{var{fpKey:o,fpLoad:i}=n,a=t(n,["fpKey","fpLoad"]);return v?(o&&i&&x(o).catch((()=>null)),e(l(a,{beforeRequest:L}))):e(a)}),(e=>i=>{var{autoRefresh:a}=i,s=t(i,["autoRefresh"]);if(!a)return e(s);const{clearAllTimers:r,setTimer:u}=(()=>{const t=[];return{clearAllTimers:()=>{for(;t.length;)clearTimeout(t.pop())},setTimer:(e,n)=>{t.push(setTimeout(e,n))}}})();let d,g;v&&document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&new Date>d&&(w("Expiration time passed, refreshing session"),p.refresh(S()||g))}));const p=e(l(s,{afterRequest:async(t,e)=>{const{refreshJwt:n,sessionJwt:i,sessionExpiration:a}=await c(e);if(401===(null==e?void 0:e.status))w("Received 401, canceling all timers"),r();else if(i||a){if(d=((t,e)=>{if(e)return new Date(1e3*e);w("Could not extract expiration time from session token, trying to decode the token");try{const e=o(t);if(e.exp)return new Date(1e3*e.exp)}catch(t){return null}})(i,a),!d)return void w("Could not extract expiration time from session token");g=n;let t=((s=d)?s.getTime()-(new Date).getTime():0)-2e4;t>h&&(w(`Timeout is too large (${t}ms), setting it to ${h}ms`),t=h),r();const e=new Date(Date.now()+t).toLocaleTimeString("en-US",{hour12:!1});w(`Setting refresh timer for ${e}. (${t}ms)`),u((()=>{w("Refreshing session due to timer"),p.refresh(S()||n)}),t)}var s}}));return n(p,["logout","logoutAll"],(t=>async(...e)=>{const n=await t(...e);return w("Clearing all timers"),r(),n}))}),(t=>e=>t(Object.assign(Object.assign({},e),{baseHeaders:Object.assign({"x-descope-sdk-name":"web-js","x-descope-sdk-version":"1.26.2"},e.baseHeaders)}))),(t=>e=>{const o=N(),i=N(),a=N(),s=t(l(e,{afterRequest:async(t,e)=>{if(401===(null==e?void 0:e.status))i.pub(null),a.pub(null),o.pub(null);else{const t=await u(e);t&&a.pub(t);const{sessionJwt:n,sessionExpiration:s}=await c(e);n&&i.pub(n),(s||n)&&o.pub(s||42)}}})),r=n(s,["logout","logoutAll"],(t=>async(...e)=>{const n=await t(...e);return i.pub(null),a.pub(null),o.pub(null),n}));return Object.assign(r,{onSessionTokenChange:i.sub,onUserChange:a.sub,onIsAuthenticatedChange:t=>o.sub((e=>{t(!!e)}))})}),(e=>o=>{var{storeLastAuthenticatedUser:i=!0,keepLastAuthenticatedUserAfterLogout:a=!1}=o,s=t(o,["storeLastAuthenticatedUser","keepLastAuthenticatedUserAfterLogout"]);if(!i)return Object.assign(e(s),{getLastUserLoginId:J,getLastUserDisplayName:_});const r=e(l(s,{afterRequest:async(t,e)=>{var n;const o=await u(e),i=null===(n=null==o?void 0:o.loginIds)||void 0===n?void 0:n[0],a=null==o?void 0:o.name;i&&((t=>{g(R,t)})(i),(t=>{g(T,t)})(a))}}));let c=n(r,["flow.start"],K);return c=n(c,["logout","logoutAll"],$(a)),Object.assign(c,{getLastUserLoginId:J,getLastUserDisplayName:_})}),(e=>o=>{var{persistTokens:i,sessionTokenViaCookie:a,storagePrefix:s}=o,r=t(o,["persistTokens","sessionTokenViaCookie","storagePrefix"]);if(!i||!v)return e(r);const u=e(l(r,{beforeRequest:(d=s,t=>Object.assign(t,{token:t.token||S(d)})),afterRequest:async(e,n)=>{const o=/^\/v\d+\/mgmt\//.test(e.path);401===(null==n?void 0:n.status)?o||k(s):((e={},n,o)=>{var{refreshJwt:i,sessionJwt:a}=e,s=t(e,["refreshJwt","sessionJwt"]);void 0===n&&(n=!1),void 0===o&&(o=""),i&&g(`${o}${b}`,i),a&&(n?y(m,a,Object.assign(Object.assign({},s),{cookieSameSite:!0===n?"Strict":n.sameSite})):g(`${o}${m}`,a))})(await c(n),a,s)}}));var d;const p=n(u,["logout","logoutAll"],P(s));return Object.assign(p,{getRefreshToken:()=>S(s),getSessionToken:()=>I(s)})}))(((...t)=>{const n=e(...t);return Object.assign(Object.assign({},n),{refresh:t=>{const e=I();return n.refresh(t,{dcs:e?"t":"f"})},flow:W(n),webauthn:X(n),fedcm:Q(n,t[0].projectId)})}));export{b as REFRESH_TOKEN_KEY,m as SESSION_TOKEN_KEY,C as clearFingerprintData,Y as default,x as ensureFingerprintIds};
//# sourceMappingURL=index.esm.js.map
